name: macOS-OpenMP-gcc

on:
  push:
    branches: [development, macOS-OpenMP]
  pull_request:
    branches: [development, macOS-OpenMP]

permissions: read-all

jobs:
  R-CMD-check:
    runs-on: macos-latest
    name: macOS-OpenMP

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      R_KEEP_PKG_SOURCE: yes

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build tools
        run: |
          # Update Homebrew and install required packages
          brew update
          brew upgrade
          brew install gcc libomp pkg-config
          brew cleanup

      - name: Setup pandoc
        uses: r-lib/actions/setup-pandoc@v2

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
          http-user-agent: 'macOS R-CMD-check'
          use-public-rspm: true

      - name: Configure R build environment
        run: |
          mkdir -p ~/.R
          GCC_PATH=$(brew --prefix gcc)
          OMP_PATH=$(brew --prefix libomp)
          SDK_PATH=$(xcrun --show-sdk-path)
          
          # Get exact GCC version from compiler binary
          GCC_VER=$(${GCC_PATH}/bin/gcc-* --version | grep -Eo '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          
          cat << EOF > ~/.R/Makevars
          # Compiler settings
          CC=${GCC_PATH}/bin/gcc-$GCC_VER
          CXX=${GCC_PATH}/bin/g++-$GCC_VER
          CXX11=${GCC_PATH}/bin/g++-$GCC_VER
          CXX14=${GCC_PATH}/bin/g++-$GCC_VER
          CXX17=${GCC_PATH}/bin/g++-$GCC_VER
          CXX20=${GCC_PATH}/bin/g++-$GCC_VER

          # OpenMP configuration
          OMP_LIB=${OMP_PATH}/lib
          OMP_INC=${OMP_PATH}/include

          # Compiler flags
          CPPFLAGS=-I${OMP_INC} -isysroot ${SDK_PATH} -fopenmp
          CFLAGS=-O3 -Wall -pedantic
          CXXFLAGS=-O3 -Wall -pedantic

          # Linker flags
          LDFLAGS=-L${OMP_LIB} -L${GCC_PATH}/lib -lomp -lgfortran -lm -isysroot ${SDK_PATH}

          # Fortran configuration
          FC=${GCC_PATH}/bin/gfortran
          F77=${FC}
          FLIBS=-L${GCC_PATH}/lib/gcc/$GCC_VER -lgfortran -lm
          EOF

      - name: Install R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::rcmdcheck
            any::reticulate
          needs: check

      - name: Setup Python for reticulate
        uses: ./.github/actions/setup-reticulate

      - name: Verify build environment
        run: |
          echo "--- Active Makevars Configuration ---"
          cat ~/.R/Makevars
          echo "\n--- Compiler Versions ---"
          $(grep '^CC=' ~/.R/Makevars | cut -d= -f2) --version
          $(grep '^CXX=' ~/.R/Makevars | cut -d= -f2) --version
          echo "\n--- OpenMP Validation ---"
          Rscript -e 'cat("OpenMP support:", system.file("include", "omp.h", package = "Rcpp"), "\n")'
          echo "\n--- Library Check ---"
          ls -l $(brew --prefix libomp)/lib/libomp.dylib

      - name: Run R CMD check
        uses: r-lib/actions/check-r-package@v2
        with:
          build-args: '--no-manual --compact-vignettes=gs+qpdf'
          check-args: '--no-manual --as-cran'
          upload-snapshots: true